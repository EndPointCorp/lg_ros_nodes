<!DOCTYPE html>
<html>

<head>
<script type="text/javascript" src="js/lib/bson.min.js"></script>
<script type="text/javascript" src="js/lib/eventemitter2.min.js"></script>
<script type="text/javascript" src="js/lib/roslib.min.js"></script>
<script type="text/javascript" src="js/util.js"></script>
<style>
body {
  background-color: black;
  height: 100%;
  width: 100%;
  margin: 0;
  overflow: hidden;
}
#stream, img {
  pointer-events: none;
}
</style>
</head>

<body>
<div id="stream"></div>
<script type="text/javascript">
// disable context menu
document.addEventListener('contextmenu', function(e) {
  e.preventDefault();
}, false);

var streamDiv = document.getElementById('stream');

var rosbridgeHost = getParameterByName('rosbridge_host', String, 'localhost');
var rosbridgePort = getParameterByName('rosbridge_port', String, '9090');
var rosbridgeSecure = getParameterByName('rosbridge_secure', stringToBoolean, 'false');
var rosbridgeUrl = getRosbridgeUrl(rosbridgeHost, rosbridgePort, rosbridgeSecure);

var viewport = getParameterByName('played_back_viewport', String);
if (!viewport) {
  console.error('Must specify viewport param');
}

// Must match the form of lg_mirror.utils.get_viewport_image_topic()
var streamTopic = '/lg_mirror/viewport/' + viewport + '/compressed';

var img = document.createElement('img');
streamDiv.appendChild(img);

var ros = new ROSLIB.Ros();
ros.connect(rosbridgeUrl);
var streamTopic = new ROSLIB.Topic({
  ros: ros,
  name: streamTopic,
  messageType: 'sensor_msgs/CompressedImage'
});

var lastBlobUrl;
streamTopic.subscribe(function(msg) {
  var contentType = 'image/' + msg.format;
  var blob = new Blob([msg.data.buffer], {type: contentType});
  var blobUrl = URL.createObjectURL(blob);
  img.src = blobUrl;
  if (lastBlobUrl) {
    URL.revokeObjectURL(lastBlobUrl);
  }
  lastBlobUrl = blobUrl;
});

</script>
</body>

</html>
